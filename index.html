<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kedai Kebun Segar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; padding-top: 20px; }
        .card { border-radius: 12px; border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stok-tag { font-size: 0.8rem; padding: 3px 8px; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4 text-success">üåø Jualan Hasil Kebun</h2>
    
    <div id="produkContainer" class="row g-3 mb-5"></div>

    <div class="card p-4 mb-5">
        <h4>Borang Pesanan</h4>
        <form id="orderForm">
            <div class="mb-3"><label>Nama</label><input type="text" id="nama" class="form-control" required></div>
            <div class="mb-3"><label>No Fon</label><input type="number" id="fon" class="form-control" placeholder="60123456789" required></div>
            <div class="mb-3"><label>Barang</label><select id="barang" class="form-select" onchange="kiraTotal()"></select></div>
            <div class="mb-3"><label>Berat (kg)</label><input type="number" id="berat" class="form-control" step="0.1" oninput="kiraTotal()" required></div>
            <h5>Total: RM <span id="totalDisplay">0.00</span></h5>
            <button type="submit" class="btn btn-success w-100 mt-3">Hantar Pesanan</button>
        </form>
    </div>

    <h4>Log Pembelian</h4>
    <div class="table-responsive"><table class="table bg-white rounded shadow-sm">
        <thead><tr><th>Nama</th><th>Barang</th><th>KG</th></tr></thead>
        <tbody id="logTabel"></tbody>
    </table></div>
</div>

<script>
    const API = "URL_APPS_SCRIPT_ANDA_DI_SINI"; // GANTI INI!
    let dataBarang = [];

    async function loadData() {
        const res = await fetch(API + "?action=getProduk");
        dataBarang = await res.json();
        let html = ""; let opt = "<option>Pilih...</option>";
        dataBarang.forEach(i => {
            html += `<div class="col-6 col-md-4"><div class="card p-3">
                <h6>${i.NamaBarang}</h6>
                <p class="mb-1 text-muted">RM${i.Harga}/kg</p>
                <span class="stok-tag ${i.Stok < 3 ? 'bg-danger text-white':'bg-light'}">Stok: ${i.Stok}kg</span>
                <a href="${i.MapLink}" target="_blank" class="btn btn-outline-primary btn-sm mt-2">üìç Lokasi</a>
            </div></div>`;
            opt += `<option value="${i.NamaBarang}">${i.NamaBarang}</option>`;
        });
        document.getElementById("produkContainer").innerHTML = html;
        document.getElementById("barang").innerHTML = opt;

        const res2 = await fetch(API + "?action=getPesanan");
        const orders = await res2.json();
        let logHtml = "";
        orders.reverse().slice(0,10).forEach(o => {
            logHtml += `<tr><td>${o.Nama}</td><td>${o.Barang}</td><td>${o.Berat}</td></tr>`;
        });
        document.getElementById("logTabel").innerHTML = logHtml;
    }

    function kiraTotal() {
        let b = document.getElementById("barang").value;
        let w = document.getElementById("berat").value;
        let item = dataBarang.find(x => x.NamaBarang == b);
        if(item) document.getElementById("totalDisplay").innerText = (item.Harga * w).toFixed(2);
    }

    document.getElementById("orderForm").onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            action: "tambahPesanan",
            nama: document.getElementById("nama").value,
            fon: document.getElementById("fon").value,
            barang: document.getElementById("barang").value,
            berat: document.getElementById("berat").value,
            total: document.getElementById("totalDisplay").innerText
        };
        await fetch(API, { method: "POST", body: JSON.stringify(payload) });
        alert("Pesanan diterima!"); location.reload();
    };

    loadData();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koperasi Perak - Tempahan Segar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .input-box { width: 100%; padding: 18px; border-radius: 25px; background: #f8fafc; border: 1px solid #e2e8f0; outline: none; font-weight: bold; font-size: 1.1rem; }
        .input-box:focus { border-color: #22c55e; background: white; }
        .card-container { background: white; border-radius: 40px; padding: 35px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); }
        .floating-footer { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; z-index: 100; }
        .btn-submit { background: #0f172a; color: white; padding: 20px; border-radius: 20px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; width: 100%; }
        /* Hilangkan anak panah input number */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="pb-44">

    <div class="bg-green-600 text-white pt-16 pb-24 px-8 rounded-b-[60px] text-center shadow-lg">
        <h1 class="text-4xl font-black tracking-tighter uppercase mb-2">KOPERASI PERAK</h1>
        <p class="text-green-100 text-xs font-bold uppercase tracking-[0.2em] opacity-90">Segar Dari Ladang Ke Meja Anda</p>
    </div>

    <div class="max-w-md mx-auto px-5 -mt-16 space-y-6">
        
        <div id="displayProduk" class="bg-white p-8 rounded-[40px] shadow-2xl border-b-8 border-green-500 hidden animate-bottom">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h2 id="viewNama" class="text-4xl font-black text-slate-800 uppercase leading-none mb-2">-</h2>
                    <div class="flex items-center gap-2">
                        <span class="bg-blue-50 text-blue-600 text-[10px] font-black px-3 py-1 rounded-full uppercase italic">üìç <span id="viewLokasi">-</span></span>
                    </div>
                </div>
                <div class="text-right bg-green-50 p-4 rounded-3xl border border-green-100">
                    <p class="text-[9px] font-black text-green-600 uppercase mb-1">Stok Baki</p>
                    <span id="viewStok" class="text-xl font-black text-slate-800 tracking-tighter">0kg</span>
                </div>
            </div>
            <div class="mt-8 flex items-end gap-1">
                <span class="text-3xl font-black text-green-500">RM</span>
                <span id="viewHarga" class="text-5xl font-black text-green-500 tracking-tighter">0</span>
                <span class="text-slate-400 font-bold mb-2 ml-1 text-xl">/kg</span>
            </div>
        </div>

        <div class="card-container space-y-6">
            <h3 class="text-center font-black text-slate-300 uppercase tracking-[0.3em] text-[10px] mb-4">Borang Pesanan</h3>
            
            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-4">Nama Anda</label>
                <input id="namaPembeli" type="text" class="input-box" placeholder="Contoh: Abu Bakar">
            </div>

            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-4">No. WhatsApp</label>
                <input id="noWA" type="number" class="input-box" placeholder="60123456789">
            </div>

            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-4">Pilih Barang</label>
                <select id="pilihBarang" onchange="updateInfoProduk()" class="input-box appearance-none">
                    <option value="">-- SILA PILIH --</option>
                </select>
            </div>

            <div class="space-y-1">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-4">Kuantiti / Berat (KG)</label>
                <div class="relative">
                    <input id="beratKg" type="number" step="0.1" 
                        class="input-box pr-16" 
                        placeholder="0.0" 
                        onfocus="if(this.value=='0.0' || this.value=='0') this.value='';" 
                        oninput="kiraTotal()">
                    <span class="absolute right-6 top-1/2 -translate-y-1/2 font-black text-slate-300 text-xl pointer-events-none">KG</span>
                </div>
                <p id="pesanStok" class="text-[10px] font-bold text-red-500 mt-2 ml-4 hidden animate-pulse">‚ö† Amaran: Melebihi baki stok yang ada!</p>
            </div>
        </div>

        <div class="px-2">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-ping"></span> Pesanan Terkini
            </p>
            <div id="logPesananContainer" class="space-y-3"></div>
        </div>
    </div>

    <div class="floating-footer px-4">
        <div class="bg-slate-900 rounded-[35px] shadow-2xl p-2">
            <div class="bg-green-500 rounded-[30px] p-6 mb-2 flex justify-between items-center text-white">
                <div>
                    <p class="text-[10px] font-bold uppercase opacity-80 mb-1">Jumlah Perlu Bayar</p>
                    <h2 class="text-4xl font-black tracking-tighter">RM <span id="totalHarga">0.00</span></h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold uppercase opacity-80">Status</p>
                    <p id="statusStok" class="text-xs font-black uppercase tracking-tighter text-slate-900 bg-white/30 px-3 py-1 rounded-full mt-1">Ready</p>
                </div>
            </div>
            <button id="btnHantar" onclick="hantarPesanan()" class="btn-submit active:scale-95 transition-all">
                Sahkan Pesanan
            </button>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbygJNpuDcoItHJ8RnWKIzqoQBJ9LX3ybjp4YmGKVVgvVEUZmo_FCuu2WpL7KsZJujxh_g/exec";
        let senaraiProduk = [];
        let produkTerpilih = null;

        async function initData() {
            try {
                // Muat Produk & Pesanan serentak
                const [resP, resO] = await Promise.all([
                    fetch(API + "?action=getProduk"),
                    fetch(API + "?action=getPesanan")
                ]);
                
                senaraiProduk = await resP.json();
                const pesanan = await resO.json();

                // Isi Select
                document.getElementById('pilihBarang').innerHTML = '<option value="">-- PILIH BARANG --</option>' + 
                    senaraiProduk.map(p => `<option value="${p.NamaBarang}">${p.NamaBarang.toUpperCase()}</option>`).join('');

                // Isi Log
                document.getElementById('logPesananContainer').innerHTML = pesanan.reverse().slice(0, 4).map(l => `
                    <div class="bg-white p-4 rounded-3xl flex justify-between items-center shadow-sm border border-slate-50">
                        <div>
                            <p class="text-xs font-black text-slate-800 uppercase">${l.NamaPembeli}</p>
                            <p class="text-[9px] text-green-600 font-bold uppercase">${l.NamaBarang} ‚Ä¢ ${l.Beratkg}KG</p>
                        </div>
                        <p class="text-sm font-black text-slate-900 tracking-tighter">RM${l.TotalHarga}</p>
                    </div>
                `).join('');
            } catch(e) { console.error(e); }
        }

        function updateInfoProduk() {
            const nama = document.getElementById('pilihBarang').value;
            produkTerpilih = senaraiProduk.find(p => p.NamaBarang === nama);
            
            if (produkTerpilih) {
                const display = document.getElementById('displayProduk');
                display.classList.remove('hidden');
                document.getElementById('viewNama').innerText = produkTerpilih.NamaBarang;
                document.getElementById('viewHarga').innerText = produkTerpilih.Hargakg;
                document.getElementById('viewStok').innerText = produkTerpilih.Stok + "kg";
                document.getElementById('viewLokasi').innerText = produkTerpilih.Lokasi || "Kebun Koperasi";
                
                const status = document.getElementById('statusStok');
                if(parseFloat(produkTerpilih.Stok) <= 0) {
                    status.innerText = "Stok Habis";
                    status.classList.replace('text-slate-900', 'text-red-600');
                } else {
                    status.innerText = "Tersedia";
                    status.classList.replace('text-red-600', 'text-slate-900');
                }
            }
            kiraTotal();
        }

        function kiraTotal() {
            const beratInput = document.getElementById('beratKg');
            const berat = parseFloat(beratInput.value) || 0;
            const amaran = document.getElementById('pesanStok');
            const btn = document.getElementById('btnHantar');

            if (produkTerpilih) {
                if (berat > parseFloat(produkTerpilih.Stok)) {
                    amaran.classList.remove('hidden');
                    btn.disabled = true;
                    btn.style.opacity = "0.3";
                } else {
                    amaran.classList.add('hidden');
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
                const total = berat * parseFloat(produkTerpilih.Hargakg);
                document.getElementById('totalHarga').innerText = total.toLocaleString('en-US', {minimumFractionDigits: 2});
            }
        }

        async function hantarPesanan() {
            const nama = document.getElementById('namaPembeli').value;
            const wa = document.getElementById('noWA').value;
            const barang = document.getElementById('pilihBarang').value;
            const berat = document.getElementById('beratKg').value;
            const total = document.getElementById('totalHarga').innerText;

            if (!nama || !wa || !barang || !berat || berat <= 0) {
                return Swal.fire({ icon: 'error', title: 'Maaf!', text: 'Sila lengkapkan semua maklumat.', border: '0', borderRadius: '30px' });
            }

            Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                const res = await fetch(API, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'tambahPesanan', namaPembeli: nama, noWhatsapp: wa, namaBarang: barang, beratKg: berat, totalHarga: total })
                });
                const result = await res.json();
                
                if (result.includes("Berjaya")) {
                    Swal.fire({ icon: 'success', title: 'Berjaya!', text: 'Pesanan anda telah diterima.', timer: 2000, showConfirmButton: false }).then(() => location.reload());
                } else {
                    Swal.fire('Gagal!', result, 'error');
                }
            } catch (e) { Swal.fire('Ralat!', 'Sila cuba sebentar lagi.', 'error'); }
        }

        initData();
    </script>
</body>
</html>

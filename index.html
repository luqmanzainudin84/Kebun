<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koperasi Agrotek Perak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f0fdf4; }
        .agrotek-bg { background-color: #166534; }
    </style>
</head>
<body class="pb-10">
    <div class="agrotek-bg text-white py-10 px-4 rounded-b-[50px] shadow-2xl text-center mb-8">
        <h1 class="text-3xl font-bold uppercase tracking-wider">Koperasi Agrotek</h1>
        <p class="text-green-200">Negeri Perak Berhad</p>
    </div>

    <div class="max-w-md mx-auto px-4">
        <div id="produkGrid" class="grid grid-cols-2 gap-3 mb-8"></div>

        <div class="bg-white p-6 rounded-3xl shadow-lg border border-green-100">
            <h3 class="font-bold text-green-800 mb-4 border-b pb-2">Borang Pembelian</h3>
            <form id="orderForm" class="space-y-4">
                <input type="text" id="nama" placeholder="Nama Anda" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-green-500" required>
                <input type="number" id="fon" placeholder="No. Telefon (6012...)" class="w-full p-3 bg-gray-50 rounded-xl outline-none border focus:border-green-500" required>
                <select id="barang" onchange="kira()" class="w-full p-3 bg-gray-50 rounded-xl border" required></select>
                <input type="number" id="berat" step="0.1" oninput="kira()" placeholder="Berat (KG)" class="w-full p-3 bg-gray-50 rounded-xl border" required>
                
                <div class="bg-yellow-50 p-4 rounded-xl flex justify-between">
                    <span class="font-bold">Total:</span>
                    <span class="font-bold text-green-700">RM <span id="total">0.00</span></span>
                </div>
                
                <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-green-700 transition">HANTAR PESANAN</button>
            </form>
        </div>

        <div class="mt-8">
            <h4 class="text-sm font-bold text-gray-400 uppercase mb-3">Log Pembelian Terkini</h4>
            <div id="log" class="bg-white rounded-2xl p-4 shadow-sm space-y-2"></div>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbygJNpuDcoItHJ8RnWKIzqoQBJ9LX3ybjp4YmGKVVgvVEUZmo_FCuu2WpL7KsZJujxh_g/exec";
        let db = [];

        async function load() {
            const res = await fetch(API + "?action=getProduk");
            db = await res.json();
            let h = ""; let opt = "<option value=''>Pilih Barang</option>";
            db.forEach(i => {
                h += `<div class="bg-white p-3 rounded-2xl shadow-sm border-b-4 border-green-600 text-center">
                    <h6 class="text-xs font-bold text-gray-500">${i.NamaBarang}</h6>
                    <p class="text-lg font-bold text-green-700">RM${i.Harga.toFixed(2)}</p>
                    <span class="text-[10px] bg-green-100 px-2 py-0.5 rounded text-green-700">Stok: ${i.Stok}kg</span>
                </div>`;
                opt += `<option value="${i.NamaBarang}">${i.NamaBarang}</option>`;
            });
            document.getElementById("produkGrid").innerHTML = h;
            document.getElementById("barang").innerHTML = opt;

            const resL = await fetch(API + "?action=getPesanan");
            const logs = await resL.json();
            let lH = "";
            logs.reverse().slice(0,5).forEach(l => {
                lH += `<div class="flex justify-between text-xs border-b pb-1"><span>${l.Nama}</span><span class="font-bold">${l.Barang} (${l.Berat}kg)</span></div>`;
            });
            document.getElementById("log").innerHTML = lH;
        }

        function kira() {
            const b = document.getElementById("barang").value;
            const w = document.getElementById("berat").value;
            const item = db.find(x => x.NamaBarang === b);
            if(item && w) document.getElementById("total").innerText = (item.Harga * w).toFixed(2);
        }

        document.getElementById("orderForm").onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById("submitBtn");
            btn.disabled = true; btn.innerText = "Sila Tunggu...";

            const payload = {
                action: "tambahPesanan",
                nama: document.getElementById("nama").value,
                fon: document.getElementById("fon").value,
                barang: document.getElementById("barang").value,
                berat: document.getElementById("berat").value,
                total: document.getElementById("total").innerText
            };

            const response = await fetch(API, { method: "POST", body: JSON.stringify(payload) });
            const result = await response.text();

            if (result === "SUCCESS") {
                Swal.fire({ title: 'Berjaya!', text: 'Pesanan anda telah direkodkan.', icon: 'success', confirmButtonColor: '#166534' })
                .then(() => location.reload());
            } else {
                Swal.fire('Ralat', 'Gagal menghantar pesanan', 'error');
                btn.disabled = false; btn.innerText = "HANTAR PESANAN";
            }
        };
        load();
    </script>
</body>
</html>

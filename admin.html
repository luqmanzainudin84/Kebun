<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Kebun</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #1a1a1a; color: white; padding: 20px; }
        .card { border: none; border-radius: 12px; }
        .order-card { background: #2d2d2d; color: white; border-left: 5px solid #198754; margin-bottom: 15px; }
        .status-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 5px; }
        .btn-wa { background-color: #25D366; color: white; border: none; }
        .btn-wa:hover { background-color: #128C7E; color: white; }
    </style>
</head>
<body>

<div class="container" style="max-width: 900px;">
    <h2 class="text-center mb-4">‚öôÔ∏è Pengurusan Kedai Kebun</h2>

    <div class="card p-4 mb-4 text-dark shadow">
        <h5>Kemaskini Harga & Stok</h5>
        <p class="text-muted small">Masukkan nama barang yang sama seperti dalam sheet untuk kemaskini.</p>
        <div class="row g-2">
            <div class="col-md-4">
                <input type="text" id="aBarang" class="form-control" placeholder="Nama Barang (Cth: Cili)">
            </div>
            <div class="col-md-3">
                <input type="number" id="aHarga" class="form-control" placeholder="Harga/kg">
            </div>
            <div class="col-md-3">
                <input type="number" id="aStok" class="form-control" placeholder="Baki Stok (kg)">
            </div>
            <div class="col-md-2">
                <button onclick="updateProduk()" id="btnUpdate" class="btn btn-primary w-100">Simpan</button>
            </div>
        </div>
    </div>

    <hr>

    <h4 class="mb-3 text-success">Senarai Pembeli & Pesanan</h4>
    <div id="adminOrders">
        <p class="text-center">Sedang memuatkan pesanan...</p>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbygJNpuDcoItHJ8RnWKIzqoQBJ9LX3ybjp4YmGKVVgvVEUZmo_FCuu2WpL7KsZJujxh_g/exec";

    // Ambil data pesanan dari sheet
    async function muatAdmin() {
        try {
            const res = await fetch(API_URL + "?action=getPesanan");
            const data = await res.json();
            let html = "";
            
            // Susun dari paling baru (atas)
            data.reverse().forEach(o => {
                const waLink = `https://wa.me/${o.Telefon}?text=Salam%20${o.Nama},%20saya%20dari%20Kebun.%20Mengenai%20pesanan%20${o.Barang}%20sebanyak%20${o.Berat}kg...`;
                
                html += `
                <div class="card order-card p-3 shadow-sm">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="mb-1 text-success">${o.Nama}</h5>
                            <p class="mb-1">üõí <b>${o.Barang}</b>: ${o.Berat}kg (RM ${o.Total})</p>
                            <p class="mb-2 small text-light">Status: 
                                <span class="badge bg-secondary status-badge">${o.StatusBayar === 'Selesai' ? '‚úÖ Dibayar' : '‚ùå Belum Bayar'}</span>
                                <span class="badge bg-secondary status-badge">${o.StatusAmbil === 'Selesai' ? '‚úÖ Diambil' : '‚ùå Belum Ambil'}</span>
                            </p>
                        </div>
                        <div class="text-end">
                            <a href="${waLink}" target="_blank" class="btn btn-sm btn-wa mb-1 d-block">WhatsApp</a>
                            <a href="tel:${o.Telefon}" class="btn btn-sm btn-outline-light mb-1 d-block">Call</a>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <button onclick="tukarStatus('${o.Nama}','${o.Telefon}','bayar')" class="btn btn-sm btn-info w-100 text-white">Set Dah Bayar</button>
                        <button onclick="tukarStatus('${o.Nama}','${o.Telefon}','ambil')" class="btn btn-sm btn-warning w-100 text-dark">Set Dah Ambil</button>
                    </div>
                </div>`;
            });
            document.getElementById("adminOrders").innerHTML = html || "<p class='text-center'>Tiada pesanan lagi.</p>";
        } catch (e) {
            document.getElementById("adminOrders").innerHTML = "Gagal memuatkan data.";
        }
    }

    async function updateProduk() {
        const btn = document.getElementById("btnUpdate");
        btn.disabled = true;
        
        const payload = {
            action: "kemaskiniStok",
            namaBarang: document.getElementById("aBarang").value,
            harga: parseFloat(document.getElementById("aHarga").value),
            stok: parseFloat(document.getElementById("aStok").value),
            lokasi: "Kebun Kita" // Boleh tukar mengikut keperluan
        };

        await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        alert("Data produk dikemaskini!");
        location.reload();
    }

    async function tukarStatus(nama, fon, jenis) {
        if(!confirm("Kemaskini status pesanan ini?")) return;
        
        const payload = {
            action: "kemaskiniStatus",
            nama: nama,
            fon: fon,
            tipe: jenis
        };

        await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
        muatAdmin();
    }

    muatAdmin();
</script>
</body>
</html>

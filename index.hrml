<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kedai Kebun Kita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .product-card { border-radius: 15px; border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stok-rendah { color: red; font-weight: bold; }
        .btn-maps { background-color: #4285F4; color: white; }
        .btn-waze { background-color: #33ccff; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">üåø Hasil Kebun Segar</h2>

    <div id="senaraiProduk" class="row">
        <p class="text-center">Sedang memuatkan barang...</p>
    </div>

    <hr>

    <div class="card p-4 shadow-sm mb-5">
        <h4>Borang Pesanan</h4>
        <form id="orderForm">
            <div class="mb-3">
                <label>Nama Anda:</label>
                <input type="text" id="nama" class="form-control" required>
            </div>
            <div class="mb-3">
                <label>No. Telefon (WhatsApp):</label>
                <input type="tel" id="fon" class="form-control" placeholder="60123456789" required>
            </div>
            <div class="mb-3">
                <label>Pilih Barang:</label>
                <select id="barang" class="form-select" onchange="kiraTotal()" required></select>
            </div>
            <div class="mb-3">
                <label id="labelBerat">Berat (kg):</label>
                <input type="number" id="berat" class="form-control" step="0.1" oninput="kiraTotal()" required>
            </div>
            <div class="mb-3">
                <h5>Total: RM <span id="totalHarga">0.00</span></h5>
            </div>
            <button type="submit" class="btn btn-success w-100">Hantar Pesanan</button>
        </form>
    </div>

    <h4>Log Pembelian Terkini</h4>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nama</th>
                    <th>Barang</th>
                    <th>Berat (kg)</th>
                </tr>
            </thead>
            <tbody id="logPembelian">
                </tbody>
        </table>
    </div>
</div>

<script>
    let hargaGlobal = {};

    // 1. Ambil data dari Google Sheet bila page load
    window.onload = function() {
        google.script.run.withSuccessHandler(paparProduk).getSheetData("Produk");
        google.script.run.withSuccessHandler(paparLog).getSheetData("Pesanan");
    };

    function paparProduk(data) {
        let html = "";
        let dropdown = "<option value=''>-- Pilih Barang --</option>";
        
        data.forEach(item => {
            hargaGlobal[item.NamaBarang] = item.Harga;
            html += `
                <div class="col-md-6">
                    <div class="card product-card p-3">
                        <h5>${item.NamaBarang}</h5>
                        <p>Harga: <b>RM ${item.Harga.toFixed(2)}/kg</b><br>
                        Stok: <span class="${item.Stok < 5 ? 'stok-rendah' : ''}">${item.Stok} kg</span></p>
                        <p><small>üìç ${item.Lokasi}</small></p>
                        <div class="d-flex gap-2">
                            <a href="${item.MapLink}" target="_blank" class="btn btn-sm btn-maps">Google Maps</a>
                        </div>
                    </div>
                </div>`;
            dropdown += `<option value="${item.NamaBarang}">${item.NamaBarang}</option>`;
        });
        document.getElementById("senaraiProduk").innerHTML = html;
        document.getElementById("barang").innerHTML = dropdown;
    }

    function kiraTotal() {
        let barang = document.getElementById("barang").value;
        let berat = document.getElementById("berat").value;
        let harga = hargaGlobal[barang] || 0;
        document.getElementById("totalHarga").innerText = (harga * berat).toFixed(2);
    }

    function paparLog(data) {
        let html = "";
        // Ambil 5 pesanan terakhir
        data.reverse().slice(0, 5).forEach(p => {
            html += `<tr><td>${p.Nama}</td><td>${p.Barang}</td><td>${p.Berat}</td></tr>`;
        });
        document.getElementById("logPembelian").innerHTML = html;
    }

    // 2. Submit form
    document.getElementById("orderForm").onsubmit = function(e) {
        e.preventDefault();
        let formData = {
            nama: document.getElementById("nama").value,
            fon: document.getElementById("fon").value,
            barang: document.getElementById("barang").value,
            berat: document.getElementById("berat").value,
            total: document.getElementById("totalHarga").innerText
        };
        
        google.script.run.withSuccessHandler(() => {
            alert("Pesanan berjaya dihantar!");
            location.reload();
        }).submitPesanan(formData);
    };
</script>
</body>
</html>
